<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>News Aggregator</title>
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="container">
    <h1>Latest News</h1>

    <div class="topic-section">
        <label for="topic">Select Topic:</label>
        <select id="topic">
            <option value="">--Select Topic--</option>
            <option value="General">General</option>
            <option value="Business">Business</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Health">Health</option>
            <option value="Science">Science</option>
            <option value="Sports">Sports</option>
            <option value="Technology">Technology</option>
            <option value="International">International</option>
        </select>
    </div>

    <button id="add-news-btn">Add News</button>

    <div id="add-news-form">
        <input type="text" id="news-title" placeholder="Enter Title">
        <textarea id="news-desc" rows="3" placeholder="Enter Description"></textarea>
        <button id="submit-news">Submit News</button>
    </div>

    <div id="news-container"></div>
</div>

<script>
const topicSelect = document.getElementById('topic');
const newsContainer = document.getElementById('news-container');
const addBtn = document.getElementById('add-news-btn');
const addForm = document.getElementById('add-news-form');
const titleInput = document.getElementById('news-title');
const descInput = document.getElementById('news-desc');
const submitBtn = document.getElementById('submit-news');

let selectedTopic = "";

// Hide Add News initially
addBtn.style.display = 'none';
addForm.style.display = 'none';

// Fetch news
async function fetchNews(topic) {
    if(!topic) return;
    newsContainer.innerHTML = 'Loading news...';
    try {
        const res = await fetch(`/news?topic=${topic}`);
        const data = await res.json();
        newsContainer.innerHTML = '';
        if(!data.articles || data.articles.length === 0){
            newsContainer.innerHTML = '<p>No news found.</p>';
            return;
        }
        data.articles.forEach(article => {
            const div = document.createElement('div');
            div.className = 'news-item';
            const labelType = article.url && article.url !== "#" ? 'live' : 'added';
            const label = `<span class="label ${labelType}">${labelType==='live'?'Live':'Added'}</span>`;
            div.innerHTML = `<div class="news-title">${article.title}</div>${label}
                             <div>${article.description}</div>`;
            newsContainer.appendChild(div);
        });
    } catch(err) {
        newsContainer.innerHTML = 'Error loading news.';
        console.error(err);
    }
}

// On topic change
topicSelect.addEventListener('change', () => {
    selectedTopic = topicSelect.value;
    if(selectedTopic) addBtn.style.display = 'inline-block';
    else addBtn.style.display = 'none';
    addForm.style.display = 'none';
    titleInput.value = '';
    descInput.value = '';
    fetchNews(selectedTopic);
});

// Show title input first
addBtn.addEventListener('click', () => {
    addForm.style.display = 'block';
    titleInput.style.display = 'block';
    descInput.style.display = 'none';
    submitBtn.style.display = 'none';
    titleInput.focus();
});

// Submit title -> show description
titleInput.addEventListener('keydown', (e) => {
    if(e.key === 'Enter'){
        e.preventDefault();
        if(!titleInput.value.trim()) return alert('Enter a title');
        titleInput.disabled = true;
        descInput.style.display = 'block';
        submitBtn.style.display = 'inline-block';
        descInput.focus();
    }
});

// Submit description -> POST news
submitBtn.addEventListener('click', async () => {
    const title = titleInput.value.trim();
    const desc = descInput.value.trim();
    if(!desc) return alert('Enter description');
    await fetch('/news', {
        method: 'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({title, description: desc, topic: selectedTopic})
    });
    titleInput.value = '';
    descInput.value = '';
    titleInput.disabled = false;
    addForm.style.display = 'none';
    fetchNews(selectedTopic);
});
</script>
</body>
</html>
